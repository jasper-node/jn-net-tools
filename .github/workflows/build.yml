name: Build and Bundle Binaries

permissions:
  contents: write

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v1.0.0)"
        required: false
        type: string

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Build macOS Intel (x86_64)
        run: cargo build -p jnnt --release --target x86_64-apple-darwin

      - name: Build macOS Apple Silicon (aarch64)
        run: cargo build -p jnnt --release --target aarch64-apple-darwin

      - name: Prepare macOS binaries
        run: |
          mkdir -p dist/macos
          cp target/x86_64-apple-darwin/release/libjnnt.dylib dist/macos/libjnnt-x86_64.dylib
          cp target/aarch64-apple-darwin/release/libjnnt.dylib dist/macos/libjnnt-aarch64.dylib

      - name: Upload macOS binaries
        uses: actions/upload-artifact@v4
        with:
          name: macos-binaries
          path: dist/macos
          retention-days: 7

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Npcap SDK
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $npcapUrl = "https://npcap.com/dist/npcap-sdk-1.13.zip"
          Invoke-WebRequest -Uri $npcapUrl -OutFile npcap-sdk.zip
          Expand-Archive -Path npcap-sdk.zip -DestinationPath C:\npcapsdk -Force
          echo "LIB=C:\npcapsdk\Lib\x64;$env:LIB" >> $env:GITHUB_ENV

      - name: Build Windows x86_64
        run: |
          cargo build -p jnnt --release --target x86_64-pc-windows-msvc

      - name: Prepare Windows binary
        run: |
          mkdir -p dist/windows
          cp target/x86_64-pc-windows-msvc/release/jnnt.dll dist/windows/libjnnt.dll

      - name: Upload Windows binary
        uses: actions/upload-artifact@v4
        with:
          name: windows-binary
          path: dist/windows
          retention-days: 7

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu,aarch64-unknown-linux-gnu

      # We install 'cross' using a binary release for speed (cargo install is slow)
      - name: Install Cross
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          cargo binstall -y cross

      # Standard build for x86 (faster to run natively than in cross)
      - name: Build Linux x86_64
        run: |
          sudo apt-get update && sudo apt-get install -y libpcap-dev
          cargo build -p jnnt --release --target x86_64-unknown-linux-gnu

      - name: Configure Cross for ARM64
        run: |
          cat > Cross.toml <<EOF
          [target.aarch64-unknown-linux-gnu]
          # Use the 'main' image tag which uses a newer Ubuntu version (usually 20.04+)
          image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu:main"
          
          pre-build = [
              "dpkg --add-architecture arm64",
              "apt-get update && apt-get install -y libpcap-dev:arm64"
          ]

          [target.aarch64-unknown-linux-gnu.env]
          # Ensure pkg-config looks at the ARM64 libraries we just installed
          PKG_CONFIG_PATH = "/usr/lib/aarch64-linux-gnu/pkgconfig"
          PKG_CONFIG_ALLOW_CROSS = "1"
          EOF

      # Cross build for ARM64 using the Cross.toml we created above
      - name: Build Linux ARM64
        run: |
          cross build -p jnnt --release --target aarch64-unknown-linux-gnu

      - name: Prepare Linux binaries
        run: |
          mkdir -p dist/linux
          cp target/x86_64-unknown-linux-gnu/release/libjnnt.so dist/linux/libjnnt-x86_64.so
          cp target/aarch64-unknown-linux-gnu/release/libjnnt.so dist/linux/libjnnt-aarch64.so

      - name: Upload Linux binaries
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: dist/linux
          retention-days: 7

  bundle:
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS binaries
        uses: actions/download-artifact@v4
        with:
          name: macos-binaries
          path: dist/artifacts/macos

      - name: Download Windows binary
        uses: actions/download-artifact@v4
        with:
          name: windows-binary
          path: dist/artifacts/windows

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: dist/artifacts/linux

      - name: Organize binaries
        run: |
          mkdir -p dist/libs/{linuxA64,linux64,mac64,macA64,win64}

          # Organize macOS binaries
          cp dist/artifacts/macos/libjnnt-x86_64.dylib dist/libs/mac64/libjnnt.dylib
          cp dist/artifacts/macos/libjnnt-aarch64.dylib dist/libs/macA64/libjnnt.dylib

          # Organize Linux binaries
          cp dist/artifacts/linux/libjnnt-x86_64.so dist/libs/linux64/libjnnt.so
          cp dist/artifacts/linux/libjnnt-aarch64.so dist/libs/linuxA64/libjnnt.so

          # Organize Windows binary
          cp dist/artifacts/windows/libjnnt.dll dist/libs/win64/

      - name: Create bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: bundled-binaries
          path: dist/libs
          retention-days: 30

      - name: List bundled files
        run: |
          echo "Bundled binaries structure:"
          find dist/libs -type f -name "*.so" -o -name "*.dll" -o -name "*.dylib" | sort

      - name: Prepare lib/ folder structure for JSR
        run: |
          mkdir -p dist/lib-jsr
          cp dist/libs/mac64/libjnnt.dylib dist/lib-jsr/jnnt-x86_64.dylib
          cp dist/libs/macA64/libjnnt.dylib dist/lib-jsr/jnnt-aarch64.dylib
          cp dist/libs/linux64/libjnnt.so dist/lib-jsr/jnnt-x86_64.so
          cp dist/libs/linuxA64/libjnnt.so dist/lib-jsr/jnnt-aarch64.so
          cp dist/libs/win64/libjnnt.dll dist/lib-jsr/jnnt.dll

      - name: Create release archive
        run: |
          cd dist/lib-jsr
          tar -czf ../lib-binaries.tar.gz .
          cd ../..

      - name: Extract version from tag
        id: tag_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag_version.outputs.version }}
          name: Release ${{ steps.tag_version.outputs.version }}
          body: |
            Pre-compiled FFI binaries for all platforms.

            ## Binaries included:
            - macOS (x86_64): `jnnt-x86_64.dylib`
            - macOS (aarch64): `jnnt-aarch64.dylib`
            - Linux (x86_64): `jnnt-x86_64.so`
            - Linux (aarch64): `jnnt-aarch64.so`
            - Windows (x86_64): `jnnt.dll`

            Extract the archive and copy the appropriate binary to `lib/` folder:
            - macOS: Use `libjnnt-x86_64.dylib` or `libjnnt-aarch64.dylib` → rename to `libjnnt.dylib`
            - Linux: Use `libjnnt-x86_64.so` or `libjnnt-aarch64.so` → rename to `libjnnt.so`
            - Windows: Use `libjnnt.dll` as-is
          files: dist/lib-binaries.zip
          draft: false
          prerelease: ${{ contains(steps.tag_version.outputs.version, '-') || contains(steps.tag_version.outputs.version, 'beta') || contains(steps.tag_version.outputs.version, 'alpha') }}
